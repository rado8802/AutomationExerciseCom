using Microsoft.Playwright;
using System;
using System.Threading.Tasks;

namespace AutomationExerciseTests.Pages
{
    public class ProductsPage
    {
        private readonly IPage _page;

        public ProductsPage(IPage page)
        {
            _page = page;
        }

        private ILocator AddToCartButton(int productId) =>
            _page.Locator($"a[data-product-id='{productId}']");

        private ILocator Modal => _page.Locator("#cartModal");
        private ILocator ContinueShoppingButton =>
            _page.Locator("#cartModal .btn.btn-success.close-modal");

        public async Task OpenAsync()
        {
            await _page.GotoAsync("https://automationexercise.com/products");
            await _page.WaitForLoadStateAsync(LoadState.NetworkIdle);
        }

        /// <summary>
        /// ГАРАНТИРАНО добавя продукт + затваря модала (работи за всички твои Cart тестове)
        /// </summary>
        public async Task AddProductAsync(int productId)
        {
            Console.WriteLine($"[AddProductAsync] Adding product {productId}...");

            await _page.Locator("div.features_items").ScrollIntoViewIfNeededAsync();

            // Клик върху Add to cart
            await AddToCartButton(productId).ClickAsync();

            // Изчакваме модала да се появи
            await Modal.WaitForAsync(new() { State = WaitForSelectorState.Visible });

            // Изчакваме fadeIn анимацията (реален проблем на сайта)
            await _page.WaitForTimeoutAsync(500);

            Console.WriteLine("[AddProductAsync] Modal is visible.");

            // Клик върху Continue Shopping
            await ContinueShoppingButton.ClickAsync();

            // Изчакване fadeOut
            await _page.WaitForTimeoutAsync(500);

            // Изчакваме модала да бъде напълно скрит
            await Modal.WaitForAsync(new() { State = WaitForSelectorState.Hidden });

            Console.WriteLine("[AddProductAsync] Modal closed successfully.");
        }

        public async Task<int> GetCartRowCountAsync()
        {
            await _page.GotoAsync("https://automationexercise.com/view_cart");
            await _page.WaitForLoadStateAsync(LoadState.NetworkIdle);

            var rows = _page.Locator("#cart_info_table tbody tr");
            return await rows.CountAsync();
        }
    }
}
